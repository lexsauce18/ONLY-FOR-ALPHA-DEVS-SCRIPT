--[[ 
    ALPHA HUB | Escape Tsunami For Brainrots
    REVISED VERSION (Rayfield)
]]

-- 1. WAIT FOR GAME TO LOAD
repeat task.wait() until game:IsLoaded()

local Player = game.Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

-- 2. NOTIFY USER
game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Alpha Hub";
    Text = "Loading Interface...";
    Duration = 5,
})

-- 3. LOAD LIBRARY (Rayfield)
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- 4. CREATE WINDOW
local Window = Rayfield:CreateWindow({
    Name = "ALPHA HUB | Escape Tsunami For Brainrots",
    LoadingTitle = "Alpha Hub Scripts",
    LoadingSubtitle = "by Alpha Hub Team",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "AlphaHubConfig",
        FileName = "AlphaHub"
    },
    Discord = {
        Enabled = false,
        Invite = "https://discord.gg/Suk9CryHvx",
        RememberJoins = true 
    },
    KeySystem = false, 
})

-- ==========================================
-- DATA & LOGIC
-- ==========================================

-- VIP Locations from your script
local vipLocations = {
	Vector3.new(241.47, 3.27, -139.51),
	Vector3.new(341.39, 3.27, -139.50),
	Vector3.new(470.24, 3.27, -139.53),
	Vector3.new(647.98, 3.27, -139.51),
	Vector3.new(917.80, 3.27, -139.51),
	Vector3.new(1321.95, 3.27, -139.51),
	Vector3.new(1912.83, 3.27, -138.53),
	Vector3.new(2427.05, 3.27, -139.01)
}

local function getNearestGapIndex()
    local character = Player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return 1 end
    local root = character.HumanoidRootPart
    local closestIndex = 1
    local shortestDistance = math.huge
    for i, gap in ipairs(gaps) do
        if gap and gap:IsA("BasePart") then
            local dist = (root.Position - gap.Position).Magnitude
            if dist < shortestDistance then
                shortestDistance = dist
                closestIndex = i
            end
        end
    end
    return closestIndex
end

-- Nearest Index function for VIP
local function getNearestVIPIndex()
    local character = Player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return 1 end
    local root = character.HumanoidRootPart
    local closestIndex = 1
    local shortestDistance = math.huge
    for i, pos in ipairs(vipLocations) do
        local distance = (root.Position - pos).Magnitude
        if distance < shortestDistance then
            shortestDistance = distance
            closestIndex = i
        end
    end
    return closestIndex
end

local function tweenToGap(index)
    local character = Player.Character
    local targetPart = gaps[index]
    if not character or not character:FindFirstChild("HumanoidRootPart") or not targetPart then return end
    local root = character.HumanoidRootPart
    local tweenInfo = TweenInfo.new(1.2, Enum.EasingStyle.Quart, Enum.EasingDirection.Out)
    local targetCFrame = targetPart.CFrame * CFrame.new(0, 7, 0)
    local tween = TweenService:Create(root, tweenInfo, {CFrame = targetCFrame})
    tween:Play()
end

-- Tween function for VIP
local function tweenToVIP(targetVector)
    local character = Player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    local root = character.HumanoidRootPart
    local tweenInfo = TweenInfo.new(1.5, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local targetCFrame = CFrame.new(targetVector + Vector3.new(0, 3, 0))
    
    root.Anchored = true
    local tween = TweenService:Create(root, tweenInfo, {CFrame = targetCFrame})
    tween:Play()
    tween.Completed:Connect(function()
        root.Anchored = false
    end)
end

-- ==========================================
-- MACHINE REMOTE (50 STUD DISTANCE EXPAND)
-- ==========================================
local SelectedMachineName = "Default"

-- AUTO-EXPAND LOGIC: Runs immediately on execution
task.spawn(function()
    while task.wait(2) do -- Checks every 2 seconds for new spawned machines
        pcall(function()
            local spawnFolder = workspace:FindFirstChild("SpawnMachines")
            if spawnFolder then
                for _, machine in ipairs(spawnFolder:GetChildren()) do
                    local prompts = machine:FindFirstChild("Main") and machine.Main:FindFirstChild("Prompts")
                    if prompts then
                        for _, prompt in ipairs(prompts:GetChildren()) do
                            if prompt:IsA("ProximityPrompt") then
                                prompt.MaxActivationDistance = 50
                            end
                        end
                    end
                end
            end
        end)
    end
end)

-- 1. Precision Fire with Stud-Distance Bypass
local function fireMachineRemote(indexOrName)
    local machine = workspace.SpawnMachines:FindFirstChild(SelectedMachineName)
    if not machine or not machine:FindFirstChild("Main") then 
        Rayfield:Notify({Title = "Error", Content = "Machine not found!", Duration = 2})
        return 
    end

    local prompts = machine.Main:FindFirstChild("Prompts")
    if not prompts then return end
    
    local target = (type(indexOrName) == "string") and prompts:FindFirstChild(indexOrName) or prompts:GetChildren()[indexOrName]

    if target and target:IsA("ProximityPrompt") then
        local root = game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root then
            local oldPos = root.CFrame
            -- Snap to machine (bypass 10/40 stud check)
            root.CFrame = machine.Main.CFrame
            task.wait(0.2) 
            
            fireproximityprompt(target)
            
            task.wait(0.1)
            root.CFrame = oldPos 
        end
    end
end

-- 2. Your Working Confirmation Logic (Force Click)
local function activateYesButton()
    local playerGui = game:GetService("Players").LocalPlayer:FindFirstChild("PlayerGui")
    local choiceMenu = playerGui and playerGui:FindFirstChild("Menus") and playerGui.Menus:FindFirstChild("Choice")
    local yesBtn = choiceMenu and choiceMenu.Choices:FindFirstChild("Yes")

    if yesBtn then
        -- Method A: Signal Simulation
        pcall(function()
            firesignal(yesBtn.MouseButton1Click)
            firesignal(yesBtn.Activated)
        end)

        -- Method B: Virtual Input Manager
        local VIM = game:GetService("VirtualInputManager")
        local x = yesBtn.AbsolutePosition.X + (yesBtn.AbsoluteSize.X / 2)
        local y = yesBtn.AbsolutePosition.Y + (yesBtn.AbsoluteSize.Y / 2) + 58
        
        VIM:SendMouseButtonEvent(x, y, 0, true, game, 0)
        task.wait(0.05)
        VIM:SendMouseButtonEvent(x, y, 0, false, game, 0)
    end
end

-- ==========================================
-- REMOTE REFERENCES
-- ==========================================
local SellAllRemote = ReplicatedStorage:WaitForChild("RemoteFunctions"):WaitForChild("SellAll")
local SellToolRemote = ReplicatedStorage:WaitForChild("RemoteFunctions"):WaitForChild("SellTool")
local UpgradeRemote = ReplicatedStorage:WaitForChild("RemoteFunctions"):WaitForChild("UpgradeSpeed")
local RebirthRemote = ReplicatedStorage:WaitForChild("RemoteFunctions"):WaitForChild("Rebirth")
local WheelRemote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RF/WheelSpin.Roll")

-- ==========================================
-- TAB 1: MAIN (User Stats)
-- ==========================================
local MainTab = Window:CreateTab("Main", 4483345998)
local InfoSection = MainTab:CreateSection("User Information")

MainTab:CreateLabel("Username: " .. Player.Name)
MainTab:CreateLabel("Display Name: " .. Player.DisplayName)
MainTab:CreateLabel("User ID: " .. Player.UserId)
MainTab:CreateLabel("Account Age: " .. Player.AccountAge .. " days")

local CreditsSection = MainTab:CreateSection("Credits")
MainTab:CreateLabel("Scripting: LexSauce / Alpha Hub Team")

local SocialSection = MainTab:CreateSection("Community")
MainTab:CreateButton({
    Name = "Copy Discord Invite",
    Callback = function()
        setclipboard("https://discord.gg/avGM6WQKCx")
        Rayfield:Notify({
            Title = "Link Copied!",
            Content = "The Discord invite has been copied to your clipboard.",
            Duration = 5,
            Image = 4483345998,
        })
    end,
})

-- ==========================================
-- TAB 2: GAME TAB
-- ==========================================
local GameTab = Window:CreateTab("Game Tab", 4483345998)

-- --- VIP NAVIGATION SECTION ---
GameTab:CreateSection("VIP Navigation ( DO NOT SPAM )")

-- THE UPDATED WALL DESTROYER
GameTab:CreateButton({
    Name = "Destroy VIP Walls",
    Callback = function()
        -- List of all possible folder locations (including ArcadeMap)
        local mapPaths = {
            workspace:FindFirstChild("ArcadeMap_SharedInstances"),
            workspace:FindFirstChild("MarsMap_SharedInstances"),
            workspace:FindFirstChild("MoneyMap_SharedInstances"),
            workspace:FindFirstChild("DefaultMap_SharedInstances")
        }

        local found = false

        -- Check defined paths first
        for _, folder in ipairs(mapPaths) do
            if folder and folder:FindFirstChild("VIPWalls") then
                folder.VIPWalls:Destroy()
                found = true
            end
        end

        -- Final deep-search backup if the folders above weren't present
        if not found then
            local backup = workspace:FindFirstChild("VIPWalls", true)
            if backup then
                backup:Destroy()
                found = true
            end
        end

        -- User Feedback
        if found then
            Rayfield:Notify({Title = "Alpha Hub", Content = "VIP Walls Destroyed!", Duration = 3})
        else
            Rayfield:Notify({Title = "Error", Content = "VIP Walls not found in any map!", Duration = 3})
        end
    end,
})

GameTab:CreateButton({
    Name = "VIP Up (+1)",
    Callback = function()
        local currentIndex = getNearestVIPIndex()
        if currentIndex < #vipLocations then
            tweenToVIP(vipLocations[currentIndex + 1])
        end
    end,
})

GameTab:CreateButton({
    Name = "VIP Down (-1)",
    Callback = function()
        local currentIndex = getNearestVIPIndex()
        if currentIndex > 1 then
            tweenToVIP(vipLocations[currentIndex - 1])
        end
    end,
})

GameTab:CreateLabel("DON'T GO NEAR THE WAVES PLAYER WILL DIE")

-- --- ESP SECTION ---
GameTab:CreateSection("ESP")

local LB_PATH = workspace:WaitForChild("ActiveLuckyBlocks")
_G.LB_ESP_Enabled = false
_G.LB_Filters = {"All"} 

local function RemoveESP(block)
    if block:FindFirstChild("ESPHighlight") then block.ESPHighlight:Destroy() end
    if block:FindFirstChild("ESPLabel") then block.ESPLabel:Destroy() end
end

local function ApplyLB_ESP(block)
    -- Ensure we don't double-up ESP on the same block
    RemoveESP(block)
    if not _G.LB_ESP_Enabled then return end

    -- Wait a tiny bit for the game to set the Rarity/Name values on spawn
    task.wait(0.1) 
    if not block.Parent then return end -- Check if it still exists

    local rarityObj = block:FindFirstChild("Rarity") or block:FindFirstChild("Type")
    local mutationObj = block:FindFirstChild("Mutation")
    
    local rarityName = rarityObj and tostring(rarityObj.Value) or block.Name
    local mutationName = mutationObj and tostring(mutationObj.Value) or ""
    local displayName = mutationName ~= "" and (mutationName .. " " .. rarityName) or rarityName
    
    local nameLower = string.lower(block.Name)
    local rarityLower = string.lower(rarityName)
    
    -- Detection Logic
    local isUfo = string.find(nameLower, "ufo") or string.find(rarityLower, "ufo")
    local isAdmin = string.find(nameLower, "admin") or string.find(rarityLower, "admin")
    local isRadioactive = string.find(nameLower, "radioactive") or string.find(rarityLower, "radioactive")
    local isMoney = string.find(nameLower, "money") or string.find(rarityLower, "money")
    local isCelestial = string.find(nameLower, "celestial") or string.find(rarityLower, "celestial")
    local isDivine = string.find(nameLower, "divine") or string.find(rarityLower, "divine")
    local isGamer = string.find(nameLower, "gamer") or string.find(rarityLower, "gamer")
    local isInfinity = string.find(nameLower, "infinity") or string.find(rarityLower, "infinity")
    
    if isUfo then displayName = "UFO LUCKY BLOCK" 
    elseif isAdmin then displayName = "ADMIN LUCKY BLOCK"
    elseif isRadioactive then displayName = "RADIOACTIVE LUCKY BLOCK"
    elseif isMoney then displayName = "MONEY LUCKY BLOCK"
    elseif isCelestial then displayName = "CELESTIAL LUCKY BLOCK"
    elseif isDivine then displayName = "DIVINE LUCKY BLOCK"
    elseif isGamer then displayName = "GAMER LUCKY BLOCK"
    elseif isInfinity then displayName = "INFINITY LUCKY BLOCK" end

    local shouldShow = false
    if table.find(_G.LB_Filters, "All") then
        shouldShow = true
    else
        for _, filterValue in ipairs(_G.LB_Filters) do
            if string.find(string.lower(displayName), string.lower(filterValue)) then
                shouldShow = true
                break
            end
        end
    end

    if not shouldShow then return end

    local hl = Instance.new("Highlight")
    hl.Name = "ESPHighlight"
    
    -- Color Logic
    if isAdmin then hl.FillColor = Color3.fromRGB(255, 50, 50) 
    elseif isRadioactive then hl.FillColor = Color3.fromRGB(150, 255, 0) 
    elseif isMoney then hl.FillColor = Color3.fromRGB(0, 255, 0)
    elseif isUfo then hl.FillColor = Color3.fromRGB(0, 255, 100) 
    elseif isCelestial then hl.FillColor = Color3.fromRGB(0, 180, 255)
    elseif isDivine then hl.FillColor = Color3.fromRGB(255, 255, 255)
    elseif isGamer then hl.FillColor = Color3.fromRGB(255, 0, 255) -- Purple/Magenta
    elseif isInfinity then hl.FillColor = Color3.fromRGB(75, 0, 130) -- Indigo
    else hl.FillColor = Color3.fromRGB(255, 215, 0) end
    
    hl.FillTransparency = 0.5
    hl.Parent = block

    local bb = Instance.new("BillboardGui")
    bb.Name = "ESPLabel"
    bb.Size = UDim2.new(0, 200, 0, 50)
    bb.StudsOffset = Vector3.new(0, 4, 0)
    bb.AlwaysOnTop = true
    
    local lbl = Instance.new("TextLabel")
    lbl.Parent = bb
    lbl.BackgroundTransparency = 1
    lbl.Size = UDim2.new(1,0,1,0)
    lbl.Text = displayName
    lbl.TextColor3 = hl.FillColor
    lbl.TextStrokeTransparency = 0
    lbl.TextScaled = true
    lbl.Font = Enum.Font.GothamBold
    bb.Parent = block
end

-- --- AUTOMATION LOGIC ---
LB_PATH.ChildAdded:Connect(function(child)
    if _G.LB_ESP_Enabled then
        ApplyLB_ESP(child)
    end
end)

GameTab:CreateToggle({
    Name = "Enable Lucky Block ESP",
    CurrentValue = false,
    Flag = "LBToggle",
    Callback = function(Value)
        _G.LB_ESP_Enabled = Value
        for _, v in ipairs(LB_PATH:GetChildren()) do 
            if Value then ApplyLB_ESP(v) else RemoveESP(v) end 
        end
    end,
})

GameTab:CreateDropdown({
    Name = "Select Rarity Filter",
    -- Added Gamer and Infinity to the options list below
    Options = {"All", "Common", "Rare", "Epic", "Legendary", "Mythical", "Cosmic", "Secret", "Celestial", "Divine", "Ufo", "Admin", "Radioactive", "Money", "Gamer", "Infinity"},
    CurrentOption = {"All"},
    MultipleOptions = true, 
    Flag = "LBFilter",
    Callback = function(Options)
        _G.LB_Filters = Options 
        for _, v in ipairs(LB_PATH:GetChildren()) do ApplyLB_ESP(v) end
    end,
})

-- --- PROXIMITY SECTION ---
GameTab:CreateSection("Interaction")

_G.InstantPrompt = false
local originalDurations = {} 

GameTab:CreateToggle({
    Name = "Instant Proximity Prompt",
    CurrentValue = false,
    Flag = "InstantPromptToggle",
    Callback = function(Value)
        _G.InstantPrompt = Value
        if Value then
            for _, obj in ipairs(workspace:GetDescendants()) do
                if obj:IsA("ProximityPrompt") then
                    if not originalDurations[obj] then
                        originalDurations[obj] = obj.HoldDuration
                    end
                    obj.HoldDuration = 0
                end
            end
        else
            for obj, duration in pairs(originalDurations) do
                if obj and obj.Parent then
                    obj.HoldDuration = duration
                end
            end
            table.clear(originalDurations)
        end
    end,
})

workspace.DescendantAdded:Connect(function(obj)
    if obj:IsA("ProximityPrompt") then
        if _G.InstantPrompt then
            task.wait() -- Ensure the prompt is fully initialized
            originalDurations[obj] = obj.HoldDuration
            obj.HoldDuration = 0
        end
    end
end)

-- --- ZOOM UNLOCK BUTTON ---
GameTab:CreateButton({
    Name = "Unlock Max Zoom",
    Callback = function()
        _G.ZoomUnlocked = true
        Rayfield:Notify({
            Title = "Zoom Unlocked",
            Content = "Max Zoom set to 1000. You can now scroll out freely!",
            Duration = 5,
            Image = 4483345998,
        })
    end,
})

task.spawn(function()
    while true do
        if _G.ZoomUnlocked then
            Player.CameraMaxZoomDistance = 1000
        end
        task.wait(0.5)
    end
end)

GameTab:CreateSection("Movement Mods")
GameTab:CreateSlider({
    Name = "WalkSpeed",
    Range = {16, 300},
    Increment = 1,
    Suffix = "Speed",
    CurrentValue = 16,
    Flag = "SliderSpeed", 
    Callback = function(Value)
        pcall(function() Player.Character.Humanoid.WalkSpeed = Value end)
    end,
})

GameTab:CreateSlider({
    Name = "JumpPower",
    Range = {50, 400},
    Increment = 1,
    Suffix = "Jump",
    CurrentValue = 50,
    Flag = "SliderJump", 
    Callback = function(Value)
        pcall(function() Player.Character.Humanoid.JumpPower = Value end)
    end,
})

GameTab:CreateToggle({
    Name = "Infinite Jump",
    CurrentValue = false,
    Flag = "ToggleInfJump", 
    Callback = function(Value)
        _G.InfJump = Value
    end,
})

GameTab:CreateSection("Fly")
local flying = false
local speed = 50
local bv, bg

GameTab:CreateToggle({
    Name = "Fly (On/Off)",
    CurrentValue = false,
    Flag = "FlyToggle",
    Callback = function(Value)
        flying = Value
        local char = Player.Character
        if flying then
            local root = char:FindFirstChild("HumanoidRootPart")
            if not root then return end
            bv = Instance.new("BodyVelocity", root)
            bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            bg = Instance.new("BodyGyro", root)
            bg.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
            bg.P = 9000
            task.spawn(function()
                while flying do
                    bg.CFrame = workspace.CurrentCamera.CFrame
                    local direction = Vector3.new(0,0,0)
                    local UIS = game:GetService("UserInputService")
                    if UIS:IsKeyDown(Enum.KeyCode.W) then direction = direction + workspace.CurrentCamera.CFrame.LookVector end
                    if UIS:IsKeyDown(Enum.KeyCode.S) then direction = direction - workspace.CurrentCamera.CFrame.LookVector end
                    if UIS:IsKeyDown(Enum.KeyCode.A) then direction = direction - workspace.CurrentCamera.CFrame.RightVector end
                    if UIS:IsKeyDown(Enum.KeyCode.D) then direction = direction + workspace.CurrentCamera.CFrame.RightVector end
                    bv.Velocity = direction * speed
                    task.wait()
                end
                if bv then bv:Destroy() end
                if bg then bg:Destroy() end
            end)
        else
            if bv then bv:Destroy() end
            if bg then bg:Destroy() end
        end
    end,
})

-- ==========================================
-- TAB 3: AUTOMATION
-- ==========================================
local Automation = Window:CreateTab("Automation", 4483345998)

--------------------------------------------------------------------------------
-- // CONFIGURATION (Internal Defaults) //
--------------------------------------------------------------------------------
getgenv().AutoCollect = false
getgenv().SelectedRarities = {} 
getgenv().TsunamiSafeDistance = 100 
getgenv().CollectionDelay = 0.5     
local SafeYHeight = -50 

local HistoryLog = {} 
local HistoryParagraph = nil 
local StatusLabel = nil

--------------------------------------------------------------------------------
-- // FUNCTIONS //
--------------------------------------------------------------------------------

local function GetCustomSpeed()
    local success, speed = pcall(function()
        local player = Players.LocalPlayer
        local speedObj = player.PlayerGui.HUD.BottomLeft.PlayerSpeed.Speed
        local rawVal = (speedObj:IsA("TextLabel") or speedObj:IsA("TextBox")) and speedObj.Text or speedObj.Value
        return tonumber(string.match(tostring(rawVal), "%d+"))
    end)
    if success and speed and speed > 0 then return speed end
    return 16 
end

local function IsTsunamiNear(targetPosition)
    local tsunamiFolder = workspace:FindFirstChild("ActiveTsunamis")
    if not tsunamiFolder then return false end
    for _, tsunami in pairs(tsunamiFolder:GetChildren()) do
        local tPos = tsunami:IsA("Model") and tsunami:GetPivot().Position or (tsunami:IsA("BasePart") and tsunami.Position)
        if tPos then
            local dist = (Vector3.new(tPos.X, 0, tPos.Z) - Vector3.new(targetPosition.X, 0, targetPosition.Z)).Magnitude
            if dist < getgenv().TsunamiSafeDistance then return true end
        end
    end
    return false 
end

local function AddToHistory(rarityName)
    local timeStr = os.date("%X")
    local logEntry = "• [" .. timeStr .. "] " .. rarityName
    table.insert(HistoryLog, 1, logEntry)
    if #HistoryLog > 10 then table.remove(HistoryLog, #HistoryLog) end
    if HistoryParagraph then HistoryParagraph:Set({Title = "Collection History", Content = table.concat(HistoryLog, "\n")}) end
end

-- UPDATED: Flexible Name Detection
local function ProcessBlock(block)
    if not getgenv().AutoCollect then return end
    
    local targetRarityName = ""
    local blockName = block.Name:lower() -- Lowercase for easier matching
    
    for _, rarity in pairs(getgenv().SelectedRarities) do
        -- Checks if the rarity string exists anywhere in the block's name
        if string.find(blockName, rarity:lower()) then
            targetRarityName = rarity
            break
        end
    end

    if targetRarityName ~= "" then
        local player = Players.LocalPlayer
        local character = player.Character
        local rootPart = character and character:FindFirstChild("HumanoidRootPart")
        
        -- Use WaitForChild in case the block parts haven't loaded yet
        local targetPart = block:WaitForChild("RootPart", 3)
        local prompt = targetPart and targetPart:WaitForChild("ProximityPrompt", 3)

        if rootPart and targetPart and prompt then
            local startPos = rootPart.Position
            local targetPos = targetPart.Position
            
            StatusLabel:Set("Status: Target Found (" .. targetRarityName .. ")")
            
            -- DIP & TWEEN
            if rootPart.Position.Y > SafeYHeight + 5 then
                rootPart.CFrame = CFrame.new(rootPart.Position.X, SafeYHeight, rootPart.Position.Z)
                task.wait(0.1)
            end
            
            local destToBlock = Vector3.new(targetPos.X, SafeYHeight, targetPos.Z)
            local distToBlock = (destToBlock - rootPart.Position).Magnitude
            local speed = GetCustomSpeed()
            
            local tween1 = TweenService:Create(rootPart, TweenInfo.new(distToBlock / speed, Enum.EasingStyle.Linear), {CFrame = CFrame.new(destToBlock)})
            tween1:Play()
            tween1.Completed:Wait()
            
            -- SAFETY CHECK
            while IsTsunamiNear(targetPos) and getgenv().AutoCollect do
                StatusLabel:Set("Status: ⚠️ Tsunami - Holding...")
                rootPart.CFrame = CFrame.new(destToBlock)
                task.wait(0.1)
            end
            
            -- COLLECT
            if getgenv().AutoCollect and block.Parent then
                StatusLabel:Set("Status: Collecting " .. targetRarityName .. "...")
                rootPart.CFrame = CFrame.new(targetPos + Vector3.new(0, 3, 0))
                
                local startTime = tick()
                while (tick() - startTime) < getgenv().CollectionDelay do
                    if not block.Parent then break end
                    rootPart.CFrame = CFrame.new(targetPos + Vector3.new(0, 3, 0))
                    rootPart.Velocity = Vector3.zero
                    
                    prompt.HoldDuration = 0
                    prompt.MaxActivationDistance = 200
                    if fireproximityprompt then fireproximityprompt(prompt) end
                    
                    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
                    task.wait(0.05)
                    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
                end

                -- RETURN
                rootPart.CFrame = CFrame.new(targetPos.X, SafeYHeight, targetPos.Z)
                local destToStart = Vector3.new(startPos.X, SafeYHeight, startPos.Z)
                local distToStart = (destToStart - rootPart.Position).Magnitude
                local tween2 = TweenService:Create(rootPart, TweenInfo.new(distToStart / speed, Enum.EasingStyle.Linear), {CFrame = CFrame.new(destToStart)})
                tween2:Play()
                tween2.Completed:Wait()
                rootPart.CFrame = CFrame.new(startPos)

                if not block.Parent then
                    Rayfield:Notify({Title = "Success", Content = "Collected " .. targetRarityName, Duration = 3, Image = 4483362458})
                    AddToHistory(targetRarityName)
                end
            end
        end
    end
end

--------------------------------------------------------------------------------
-- // UI ELEMENTS //
--------------------------------------------------------------------------------

local Section = Automation:CreateSection("Status & Settings")
StatusLabel = Automation:CreateLabel("Status: Idle")

-- CONTINUOUS LISTENER
task.spawn(function()
    local blockFolder = workspace:WaitForChild("ActiveLuckyBlocks", 10)
    if blockFolder then
        blockFolder.ChildAdded:Connect(function(child)
            if getgenv().AutoCollect then
                task.wait(0.1) -- Small delay to ensure block is fully initialized
                ProcessBlock(child)
            end
        end)
    end
end)

local RarityDropdown = Automation:CreateDropdown({
   Name = "Select Rarities",
   Options = {
       "Common", "Uncommon", "Rare", "Epic", "Legendary", 
       "Mythical", "Cosmic", "Secret", "Celestial", "Divine", "Infinity"
   },
   CurrentOption = {"Common"},
   MultipleOptions = true,
   Flag = "RarityDropdown",
   Callback = function(Options) getgenv().SelectedRarities = Options end,
})

local Toggle = Automation:CreateToggle({
   Name = "Enable Auto Collect",
   CurrentValue = false,
   Flag = "AutoCollectLucky",
   Callback = function(Value)
      getgenv().AutoCollect = Value
      
      if Value then
          task.spawn(function()
             while getgenv().AutoCollect do
                StatusLabel:Set("Status: Scanning...")
                local blockFolder = workspace:FindFirstChild("ActiveLuckyBlocks")
                if blockFolder then
                   for _, block in pairs(blockFolder:GetChildren()) do
                       if not getgenv().AutoCollect then break end
                       ProcessBlock(block)
                   end
                end
                task.wait(2) 
             end
             StatusLabel:Set("Status: Idle")
          end)
      else
          StatusLabel:Set("Status: Idle")
      end
   end,
})

-- Feature Logic Variables
local AutoCollect = false

-- Improved function to find the nearest candy
local function getNearestCandy()
    local Character = game.Players.LocalPlayer.Character
    if not Character or not Character:FindFirstChild("HumanoidRootPart") then return nil end
    
    local HRP = Character.HumanoidRootPart
    local nearestCandy = nil
    local shortestDistance = math.huge
    
    -- Check if the folder exists
    local candyFolder = workspace:FindFirstChild("CandyEventParts")
    
    if candyFolder then
        for _, candy in pairs(candyFolder:GetChildren()) do
            -- Use Pivot position to support Models AND Parts
            local candyPos = (candy:IsA("Model") and candy:GetPivot().Position) or (candy:IsA("BasePart") and candy.Position)
            
            if candyPos then
                local distance = (HRP.Position - candyPos).Magnitude
                if distance < shortestDistance then
                    shortestDistance = distance
                    nearestCandy = candy
                end
            end
        end
    end
    return nearestCandy
end

-- Remote Automation Section
Automation:CreateSection("Valentines Event")

-- Button with specific Index Teleport Logic
Automation:CreateButton({
   Name = "TP & Deposit Candy",
   Callback = function()
      local character = game.Players.LocalPlayer.Character
      local station = workspace:FindFirstChild("ValentinesMap") and workspace.ValentinesMap:FindFirstChild("CandyGramStation")
      local prompt = station and station:FindFirstChild("Main") 
                     and station.Main:FindFirstChild("Prompts") 
                     and station.Main.Prompts:FindFirstChild("ProximityPrompt")
      
      -- Using specifically requested index [56] for teleport location
      local tpTarget = station and station:GetChildren()[56]
      
      if character and tpTarget and prompt then
         -- Teleport to the part at index 56
         if tpTarget:IsA("Model") then
             character:PivotTo(tpTarget:GetPivot())
         elseif tpTarget:IsA("BasePart") then
             character:PivotTo(tpTarget.CFrame)
         end
         
         -- Small wait to ensure character is in range before firing
         task.wait(0.1)
         
         -- Fire the prompt
         fireproximityprompt(prompt)
      else
         warn("Required parts (Index 56 or Prompt) not found!")
      end
   end,
})

-- Toggle for Nearest Teleport
Automation:CreateToggle({
   Name = "Auto TP to Nearest Candy",
   CurrentValue = false,
   Flag = "CandyTPToggle",
   Callback = function(Value)
      AutoCollect = Value
      
      if AutoCollect then
         task.spawn(function()
            while AutoCollect do
               local target = getNearestCandy()
               local character = game.Players.LocalPlayer.Character
               
               if target and character then
                  -- PivotTo is the most modern and reliable way to TP
                  local targetCFrame = (target:IsA("Model") and target:GetPivot()) or (target:IsA("BasePart") and target.CFrame)
                  
                  if targetCFrame then
                      character:PivotTo(targetCFrame)
                  end
               end
               task.wait(0.2) 
            end
         end)
      end
   end,
})


--- AUTO COIN EVENT ---

Automation:CreateSection("Auto Collect Coins")

_G.AutoCollectArcade = false
_G.AutoCollectTickets = false -- New Toggle Variable

-- [ARCADE CONSOLES]
Automation:CreateToggle({
    Name = "Auto-Collect Arcade Consoles",
    CurrentValue = false,
    Flag = "ArcadeToggle",
    Callback = function(Value)
        _G.AutoCollectArcade = Value
        if _G.AutoCollectArcade then
            task.spawn(function()
                while _G.AutoCollectArcade do
                    pcall(function()
                        local arcadeFolder = workspace:FindFirstChild("ArcadeEventConsoles")
                        local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
                        
                        if arcadeFolder and hrp then
                            for _, console in ipairs(arcadeFolder:GetChildren()) do
                                if not _G.AutoCollectArcade then break end
                                local targetPart = console:FindFirstChild("Game Console") or (console:IsA("BasePart") and console)
                                
                                if targetPart and hrp then
                                    -- FLING FIX --
                                    targetPart.CanCollide = false
                                    targetPart.Velocity = Vector3.new(0,0,0)
                                    
                                    targetPart.CFrame = hrp.CFrame
                                    task.delay(0.9, function()
                                        if console then console:Destroy() end
                                    end)
                                end
                            end
                        end
                    end)
                    task.wait(1)
                end
            end)
        end
    end,
})

-- [ARCADE TICKETS] - NEW ADDITION
Automation:CreateToggle({
    Name = "Auto-Collect Arcade Tickets",
    CurrentValue = false,
    Flag = "TicketToggle",
    Callback = function(Value)
        _G.AutoCollectTickets = Value
        if _G.AutoCollectTickets then
            task.spawn(function()
                while _G.AutoCollectTickets do
                    pcall(function()
                        local ticketFolder = workspace:FindFirstChild("ArcadeEventTickets")
                        local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
                        
                        if ticketFolder and hrp then
                            for _, ticketModel in ipairs(ticketFolder:GetChildren()) do
                                if not _G.AutoCollectTickets then break end
                                
                                -- Targets the "Ticket" part inside the model
                                local realTicket = ticketModel:FindFirstChild("Ticket")
                                if realTicket and realTicket:IsA("BasePart") then
                                    -- FLING FIX --
                                    realTicket.CanCollide = false
                                    realTicket.Velocity = Vector3.new(0,0,0)
                                    
                                    -- Bring the ticket to you and trigger the touch
                                    realTicket.CFrame = hrp.CFrame
                                    firetouchinterest(hrp, realTicket, 0)
                                    task.wait(0.05) -- Brief wait to ensure registration
                                    firetouchinterest(hrp, realTicket, 1)
                                    
                                    -- REMOVED: ticketModel:Destroy() 
                                    -- Let the game server handle the removal upon successful collection
                                end
                            end
                        end
                    end)
                    task.wait(1)
                end
            end)
        end
    end,
})

-- [MONEY COINS]
_G.AutoTPMoneyEvent = false
_G.MoneyTPDelay = 0.2 

Automation:CreateToggle({
    Name = "Auto-Collect All Money Coins",
    CurrentValue = false,
    Flag = "MoneyEventTPToggle",
    Callback = function(Value)
        _G.AutoTPMoneyEvent = Value
        if Value then
            task.spawn(function()
                while _G.AutoTPMoneyEvent do
                    local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
                    local moneyFolder = workspace:FindFirstChild("MoneyEventParts")
                    
                    if hrp and moneyFolder then
                        for _, coin in ipairs(moneyFolder:GetChildren()) do
                            if not _G.AutoTPMoneyEvent then break end
                            local mainPart = coin:FindFirstChild("Main")
                            
                            if mainPart and mainPart:IsA("BasePart") then
                                -- FLING FIX --
                                mainPart.CanCollide = false
                                mainPart.Velocity = Vector3.zero
                                mainPart.RotVelocity = Vector3.zero
                                
                                mainPart.CFrame = hrp.CFrame * CFrame.new(0, 0, -1)
                                firetouchinterest(hrp, mainPart, 0)
                                task.wait(0.05)
                                firetouchinterest(hrp, mainPart, 1)
                                
                                task.delay(0.9, function()
                                    if coin and coin.Parent then coin:Destroy() end
                                end)
                                task.wait(_G.MoneyTPDelay)
                            end
                        end
                    end
                    task.wait(1) 
                end
            end)
        end
    end,
})

-- [UFO COINS]
_G.AutoCollectUFO = false
_G.UFO_Delay = 0.15

Automation:CreateToggle({
    Name = "Auto-Collect UFO Coins",
    CurrentValue = false,
    Flag = "UFOToggle",
    Callback = function(Value)
        _G.AutoCollectUFO = Value
        if _G.AutoCollectUFO then
            task.spawn(function()
                local CoinBombEvent = ReplicatedStorage.Packages.Net:FindFirstChild("RE/CoinBombEvent")
                while _G.AutoCollectUFO do
                    local UFOParts = workspace:FindFirstChild("UFOEventParts")
                    if UFOParts then
                        for _, coin in ipairs(UFOParts:GetChildren()) do
                            if not _G.AutoCollectUFO then break end
                            local hitbox = coin:FindFirstChild("Hitbox")
                            local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
                            
                            if hitbox and hrp then
                                -- FLING FIX --
                                hitbox.CanCollide = false
                                hitbox.Velocity = Vector3.zero
                                
                                hitbox.CFrame = hrp.CFrame
                                if CoinBombEvent then CoinBombEvent:FireServer(coin) end
                                task.delay(0.9, function()
                                    if coin then coin:Destroy() end
                                end)
                            end
                            task.wait(_G.UFO_Delay)
                        end
                    end
                    task.wait(1)
                end
            end)
        end
    end,
})

-- [RADIOACTIVE COINS]
_G.AutoCollectRadioactive = false
Automation:CreateToggle({
    Name = "Auto-Collect Radioactive Coins",
    CurrentValue = false,
    Flag = "RadioactiveToggle",
    Callback = function(Value)
        _G.AutoCollectRadioactive = Value
        if _G.AutoCollectRadioactive then
            task.spawn(function()
                while _G.AutoCollectRadioactive do
                    pcall(function()
                        local eventFolder = workspace:FindFirstChild("EventParts")
                        local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
                        
                        if eventFolder and hrp then
                            for _, folder in ipairs(eventFolder:GetChildren()) do
                                for _, coin in ipairs(folder:GetChildren()) do
                                    if coin.Name == "Radioactive Coin" then
                                        -- FLING FIX --
                                        coin.CanCollide = false
                                        coin.Velocity = Vector3.zero
                                        
                                        coin.CFrame = hrp.CFrame
                                        task.delay(0.9, function() 
                                            if coin then coin:Destroy() end 
                                        end)
                                    end
                                end
                            end
                        end
                    end)
                    task.wait(0.5)
                end
            end)
        end
    end,
})

Automation:CreateSection("Selling System")

Automation:CreateButton({
    Name = "Sell Holding",
    Callback = function()
        local tool = Player.Character and Player.Character:FindFirstChildOfClass("Tool")
        if tool then
            SellToolRemote:InvokeServer(tool)
        else
            Rayfield:Notify({Title = "Error", Content = "Hold an item to sell it!", Duration = 3})
        end
    end,
})

Automation:CreateButton({
    Name = "Sell All Items",
    Callback = function()
        SellAllRemote:InvokeServer()
    end,
})

Automation:CreateSection("Upgrades & Rebirth")

_G.AutoBuySpeed = false
Automation:CreateToggle({
   Name = "Auto-Buy Speed Upgrades",
   CurrentValue = false,
   Flag = "AutoBuyToggle",
   Callback = function(Value)
       _G.AutoBuySpeed = Value
       if _G.AutoBuySpeed then
           task.spawn(function()
               while _G.AutoBuySpeed do
                   pcall(function()
                       UpgradeRemote:InvokeServer(10)
                   end)
                   task.wait(0.5)
               end
           end)
       end
   end,
})

_G.AutoRebirth = false
Automation:CreateToggle({
    Name = "Auto-Rebirth (Fast)",
    CurrentValue = false,
    Flag = "AutoRebirthToggle",
    Callback = function(Value)
        _G.AutoRebirth = Value
        if _G.AutoRebirth then
            task.spawn(function()
                while _G.AutoRebirth do
                    pcall(function() RebirthRemote:InvokeServer() end)
                    task.wait(1)
                end
            end)
        end
    end,
})

-- // PLOT DETECTION LOGIC //
local MyPlotID = "Searching..."
local SelectedStands = {"5"}

local function FindMyBase()
    local basesFolder = workspace:FindFirstChild("Bases")
    if not basesFolder then return nil end
    for _, base in pairs(basesFolder:GetChildren()) do
        local pNameLabel = base:FindFirstChild("PlayerName", true) -- Recursive search for the name label
        if pNameLabel and (pNameLabel.Text == Player.Name or pNameLabel.Text == Player.DisplayName or string.find(pNameLabel.Text, Player.Name)) then
            return base.Name 
        end
    end
    return nil
end

task.spawn(function()
    while MyPlotID == "Searching..." do
        local id = FindMyBase()
        if id then MyPlotID = id break end
        task.wait(2)
    end
end)

-- --- BRAINROT PLOT SECTION ---

Automation:CreateSection("Auto Upgrade & Collect Money")

-- Money collection kept exactly as requested
Automation:CreateToggle({
   Name = "Auto-Collect Money",
   CurrentValue = false,
   Flag = "AutoCollPlot",
   Callback = function(Value)
      _G.AutoCollectPlot = Value
      if Value then
         task.spawn(function()
            local remote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):FindFirstChild("RF/Plot.PlotAction")
            while _G.AutoCollectPlot do
               if MyPlotID ~= "Searching..." and remote then
                  for i = 1, 99 do
                     if not _G.AutoCollectPlot then break end
                     pcall(function() remote:InvokeServer("Collect Money", MyPlotID, tostring(i)) end)
                     task.wait(0.01)
                  end
               end
               task.wait(1)
            end
         end)
      end
   end,
})

Automation:CreateDropdown({
    Name = "Select Target Stands",
    -- Options now go up to 35
    Options = {"1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35"},
    CurrentOption = {"5"},
    MultipleOptions = true,
    Flag = "GlobalStandSelector",
    Callback = function(Options) SelectedStands = Options end,
})

-- Variable to control the loop
_G.AutoUpgradeBrainrot = false

-- The Toggle: For hands-free upgrading
Automation:CreateToggle({
    Name = "Auto-Upgrade Brainrot (Loop)",
    CurrentValue = false,
    Flag = "AutoUpgLoop",
    Callback = function(Value)
        _G.AutoUpgradeBrainrot = Value
        
        if Value then
            task.spawn(function()
                local remote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):FindFirstChild("RF/Plot.PlotAction")
                
                while _G.AutoUpgradeBrainrot do
                    if MyPlotID ~= "Searching..." and remote then
                        for _, standNum in ipairs(SelectedStands) do
                            -- Check current level before spamming
                            local currentLevel = 0
                            pcall(function()
                                local plot = workspace.Bases:FindFirstChild(MyPlotID)
                                local stand = plot.Stands:FindFirstChild(tostring(standNum))
                                local lvlObj = stand:FindFirstChild("Level") or stand:FindFirstChild("Stage") or (stand:FindFirstChild("Configuration") and stand.Configuration:FindFirstChild("Level"))
                                
                                if lvlObj then
                                    currentLevel = lvlObj.Value
                                elseif stand:GetAttribute("Level") then
                                    currentLevel = stand:GetAttribute("Level")
                                end
                            end)

                            -- Only upgrade if below 175
                            if currentLevel < 175 then
                                pcall(function() 
                                    remote:InvokeServer("Upgrade Brainrot", MyPlotID, tostring(standNum)) 
                                end)
                            end
                        end
                    end
                    -- Small wait between loop cycles to prevent lag
                    task.wait(0.1) 
                end
            end)
        end
    end,
})

Automation:CreateButton({
    Name = "Instant Max Brainrot (200)", -- Updated Name
    Callback = function()
       if MyPlotID == "Searching..." then Rayfield:Notify({Title = "Error", Content = "Base not found!", Duration = 3}) return end
       local remote = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):FindFirstChild("RF/Plot.PlotAction")
       
       for _, standNum in ipairs(SelectedStands) do
          task.spawn(function()
             local currentLevel = 0
             pcall(function()
                 local plot = workspace.Bases:FindFirstChild(MyPlotID)
                 local stand = plot.Stands:FindFirstChild(tostring(standNum))
                 local lvlObj = stand:FindFirstChild("Level") or stand:FindFirstChild("Stage") or (stand:FindFirstChild("Configuration") and stand.Configuration:FindFirstChild("Level"))
                 
                 if lvlObj then 
                    currentLevel = lvlObj.Value
                 elseif stand:GetAttribute("Level") then 
                    currentLevel = stand:GetAttribute("Level") 
                 end
             end)

             local MAX_LEVEL = 200 -- Updated Max Level
             local needed = MAX_LEVEL - currentLevel
             
             if needed > 0 then
                 for i = 1, needed do
                    task.spawn(function() 
                        pcall(function() remote:InvokeServer("Upgrade Brainrot", MyPlotID, tostring(standNum)) end)
                    end)
                    -- Small delay every 15 iterations to prevent potential remote exhaustion/kick
                    if i % 15 == 0 then task.wait(0.02) end 
                 end
             end
          end)
       end
       Rayfield:Notify({Title = "Alpha Hub", Content = "Upgrading to Level 200...", Duration = 2})
    end,
})

Automation:CreateSection("Auto Spawn Machine")

local isRunning = false

Automation:CreateToggle({
   Name = "Auto Steal Common Brainrot [fuse]",
   CurrentValue = false,
   Flag = "BrainrotToggle", -- Unique identifier for config saving
   Callback = function(Value)
      isRunning = Value
      
      if isRunning then
         -- Run the logic in a separate thread so the UI doesn't freeze
         task.spawn(function()
            local COMMON_FOLDER = workspace:WaitForChild("ActiveBrainrots"):WaitForChild("Common")
            local SAFE_ZONE = workspace:WaitForChild("Misc"):WaitForChild("Ground")
            local PLAYER = game.Players.LocalPlayer
            
            while isRunning do
               local CHARACTER = PLAYER.Character
               local ROOT = CHARACTER and CHARACTER:FindFirstChild("HumanoidRootPart")
               
               if ROOT then
                  local targets = COMMON_FOLDER:GetChildren()
                  
                  if #targets > 0 then
                     local target = targets[1]
                     -- Safely find the prompt based on your example
                     local prompt = target:FindFirstChild("Root") and target.Root:FindFirstChild("TakePrompt")
                     
                     if prompt then
                        -- Teleport to Brainrot
                        ROOT.CFrame = target.Root.CFrame
                        task.wait(0.3)
                        
                        -- Steal it
                        fireproximityprompt(prompt)
                        task.wait(0.2)
                        
                        -- Return to Safezone
                        ROOT.CFrame = SAFE_ZONE.CFrame + Vector3.new(0, 3, 0)
                        task.wait(0.5)
                     end
                  end
               end
               task.wait(0.1) -- Small delay to prevent lag
            end
         end)
      end
   end,
})

Automation:CreateDropdown({
   Name = "Select Machine",
   Options = {"Default", "ATM", "Blackhole", "Arcade"}, 
   CurrentOption = {"Default"},
   Callback = function(Option) SelectedMachineName = Option[1] end,
})

Automation:CreateButton({
    Name = "Deposit (Hold Item)",
    Callback = function()
        fireMachineRemote("ProximityPrompt")
    end,
})

Automation:CreateButton({
    Name = "Blink-Craft (Auto Confirm)",
    Callback = function()
        local machine = workspace.SpawnMachines:FindFirstChild(SelectedMachineName)
        local root = game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        
        if machine and root then
            local oldPos = root.CFrame
            
            -- 1. Blink to Machine
            root.CFrame = machine.Main.CFrame
            task.wait(0.2)
            
            -- 2. Fire Craft Prompt (Index 2)
            local prompts = machine.Main:FindFirstChild("Prompts")
            local craftPrompt = prompts and prompts:GetChildren()[2]
            if craftPrompt then fireproximityprompt(craftPrompt) end
            
            -- 3. Wait for UI delay and Force Click
            task.wait(0.4) 
            activateYesButton()
            
            -- 4. Return to last location
            task.wait(0.1)
            root.CFrame = oldPos
            Rayfield:Notify({Title = "Success", Content = "Blink-Craft Completed for " .. SelectedMachineName, Duration = 2})
        end
    end,
})

Automation:CreateButton({
    Name = "Withdraw All Brainrots",
    Callback = function()
        fireMachineRemote(3)
    end,
})

-- ==========================================
-- VARIABLES & UTILS
-- ==========================================
local SelectedMachineName = "Default"
local TargetToolID = nil 
local AutoEquipEnabled = false
local AutoCraftEnabled = false
local AutoDepositEnabled = false
local CraftCooldown = 30

local function fireMachineRemote(indexOrName)
    local machine = workspace.SpawnMachines:FindFirstChild(SelectedMachineName)
    if not machine or not machine:FindFirstChild("Main") then return end

    local prompts = machine.Main:FindFirstChild("Prompts")
    if not prompts then return end
    
    local target = (type(indexOrName) == "string") and prompts:FindFirstChild(indexOrName) or prompts:GetChildren()[indexOrName]

    if target and target:IsA("ProximityPrompt") then
        local root = game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        if root then
            local oldPos = root.CFrame
            root.CFrame = machine.Main.CFrame
            task.wait(0.3) 
            fireproximityprompt(target)
            task.wait(0.1)
            root.CFrame = oldPos 
        end
    end
end

-- ==========================================
-- TAB 3:  AFK FUSE MACHINE
-- ==========================================
local Afk = Window:CreateTab("Afk Fuse", 4483345998)
Afk:CreateSection("Afk Status")
-- Variables
local selectedTime = 30
local selectedMachine = "Default"
local autoDeposit = false
local autoCraft = false
local countdown = 0
local isProcessing = false
local copiedItemID = nil
local autoEquipEnabled = false

-- Machine Names for Auto-Detection
local machineNames = {"ATM", "Blackhole", "Arcade", "Valentines"}

-- Coordinates
local machineCoords = Vector3.new(897.34, -8.38, -23.02)
local atmCoords = Vector3.new(897.96, -8.39, 27.33)
local surfaceCoords = Vector3.new(125.89, 3.22, 0.72)
local defaultBlinkCoords = Vector3.new(135.40, 3.22, 138.60)

-- Helper: Create/Manage Following Platform
local function updatePlatform()
    local hrp = game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local plat = workspace:FindFirstChild("AutoFarmPlatform")
    if not plat then
        plat = Instance.new("Part", workspace)
        plat.Name = "AutoFarmPlatform"
        plat.Size = Vector3.new(15, 1, 15)
        plat.Anchored = true
        plat.Transparency = 0.5
        plat.BrickColor = BrickColor.new("Neon orange")
        plat.CanCollide = true
    end
    -- Keep platform 3.5 studs below the player at all times
    plat.CFrame = hrp.CFrame * CFrame.new(0, -3.5, 0)
end

-- Helper: Find Any Machine
local function getActiveMachine()
    local folder = workspace:WaitForChild("SpawnMachines")
    if selectedMachine == "Default" then
        return folder:FindFirstChild("Default")
    elseif selectedMachine == "Auto-Detect Others" then
        for _, name in ipairs(machineNames) do
            local found = folder:FindFirstChild(name)
            if found then return found end
        end
    else
        return folder:FindFirstChild(selectedMachine)
    end
    return nil
end

-- Helper: Tween Functions
local function tweenToMachine(targetPos)
    local hrp = game.Players.LocalPlayer.Character:WaitForChild("HumanoidRootPart")
    local ts = game:GetService("TweenService")
    local info = TweenInfo.new(2, Enum.EasingStyle.Linear)
    ts:Create(hrp, info, {CFrame = CFrame.new(hrp.Position.X, targetPos.Y, hrp.Position.Z)}):Play()
    task.wait(2.1)
    ts:Create(hrp, info, {CFrame = CFrame.new(targetPos)}):Play()
    task.wait(2.1)
end

local function tweenToSurface(targetPos)
    local hrp = game.Players.LocalPlayer.Character:WaitForChild("HumanoidRootPart")
    local ts = game:GetService("TweenService")
    local info = TweenInfo.new(2, Enum.EasingStyle.Linear)
    ts:Create(hrp, info, {CFrame = CFrame.new(targetPos.X, hrp.Position.Y, targetPos.Z)}):Play()
    task.wait(2.1)
    ts:Create(hrp, info, {CFrame = CFrame.new(targetPos)}):Play()
end

local TimeLabel = Afk:CreateLabel("Next Cycle: Ready")

Afk:CreateSection("Afk Settings")

-----------------------------------------------------------
-- AUTO BRAINROT EQUIP UI
-----------------------------------------------------------
local IDLabel = Afk:CreateLabel("Current ID: None")

Afk:CreateButton({
    Name = "Copy Held Item ID",
    Callback = function()
        local tool = game.Players.LocalPlayer.Character:FindFirstChildOfClass("Tool")
        if tool then 
            copiedItemID = tool.Name 
            IDLabel:Set("Current ID: "..tool.Name) 
            setclipboard(tool.Name) 
            Rayfield:Notify({Title = "ID Copied", Content = "Item: " .. tool.Name .. " copied to clipboard", Duration = 3})
        else
            Rayfield:Notify({Title = "Error", Content = "Please hold an item first!", Duration = 3})
        end
    end,
})

Afk:CreateToggle({
    Name = "Auto Equip Item", 
    CurrentValue = false, 
    Callback = function(v) 
        autoEquipEnabled = v 
    end
})

-----------------------------------------------------------
-- CORE AUTOMATION LOOP
-----------------------------------------------------------
spawn(function()
    while task.wait(0.1) do -- Faster wait to keep platform updated
        if autoDeposit or autoCraft then
            -- Logic to move the platform under the player while active
            updatePlatform()

            if countdown <= 0 and not isProcessing then
                local machineObj = getActiveMachine()
                
                if not machineObj then
                    TimeLabel:Set("Waiting for machine...")
                    continue 
                end

                isProcessing = true
                
                local remote = game:GetService("ReplicatedStorage"):WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RF/SpawnMachine.Action")
                local hrp = game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")

                if hrp then
                    local targetPos = (machineObj.Name == "ATM") and atmCoords or machineCoords

                    if machineObj.Name == "Default" then
                        hrp.CFrame = CFrame.new(defaultBlinkCoords)
                        task.wait(0.5)
                    else
                        local dist = (hrp.Position - targetPos).Magnitude
                        if dist > 10 then
                            TimeLabel:Set("Status: Traveling...")
                            tweenToMachine(targetPos)
                        end
                    end

                    if autoDeposit then
                        TimeLabel:Set("Status: Depositing...")
                        pcall(function() remote:InvokeServer(unpack({"Deposit", machineObj})) end)
                        task.wait(1.5)
                    end

                    if autoCraft then
                        TimeLabel:Set("Status: Crafting...")
                        pcall(function() remote:InvokeServer(unpack({"Combine", machineObj})) end)
                        task.wait(2)
                    end

                    countdown = selectedTime
                end
                isProcessing = false
            elseif countdown > 0 then
                countdown = countdown - 0.1
                if math.floor(countdown * 10) % 10 == 0 then -- Update label every second
                    TimeLabel:Set(countdown >= 60 and "Next Cycle: "..math.floor(countdown/60).."m "..(math.floor(countdown)%60).."s" or "Next Cycle: "..math.floor(countdown).."s")
                end
            end
        else
            -- Cleanup platform when automation is off
            local plat = workspace:FindFirstChild("AutoFarmPlatform")
            if plat then plat:Destroy() end
            
            TimeLabel:Set("Automation: Paused")
            countdown = 0
            isProcessing = false
            task.wait(0.9) -- Reduce lag when paused
        end
    end
end)

-- Auto Equip Loop (Fast check)
spawn(function()
    while task.wait(0.5) do
        if autoEquipEnabled and copiedItemID then
            local p = game.Players.LocalPlayer
            if p.Character and not p.Character:FindFirstChild(copiedItemID) then
                local t = p.Backpack:FindFirstChild(copiedItemID)
                if t then t.Parent = p.Character end
            end
        end
    end
end)

-----------------------------------------------------------
-- AUTOMATION SETTINGS UI
-----------------------------------------------------------
Afk:CreateDropdown({
    Name = "Set Interval",
    Options = {"30 Seconds", "1 Minute", "5 Minutes", "10 Minutes", "20 Minutes", "30 Minutes", "45 Minutes", "60 Minutes"},
    CurrentOption = {"30 Seconds"},
    Callback = function(Option)
        local times = {["30 Seconds"]=30,["1 Minute"]=60,["5 Minutes"]=300,["10 Minutes"]=600,["20 Minutes"]=1200,["30 Minutes"]=1800,["45 Minutes"]=2700,["60 Minutes"]=3600}
        selectedTime = times[Option[1]] or 30
        countdown = 0
    end,
})

Afk:CreateDropdown({
    Name = "Select Machine Mode",
    Options = {"Default", "Auto-Detect Others", "ATM", "Blackhole", "Arcade", "Valentines"},
    CurrentOption = {"Default"},
    Callback = function(Option) selectedMachine = Option[1] end,
})

Afk:CreateToggle({
    Name = "Auto Deposit",
    CurrentValue = false,
    Callback = function(v) autoDeposit = v end,
})

Afk:CreateToggle({Name = "Auto Craft", CurrentValue = false, Callback = function(v) autoCraft = v end})

Afk:CreateButton({
    Name = "Withdraw All Brainrots",
    Callback = function()
        local m = getActiveMachine()
        if m then
            game:GetService("ReplicatedStorage"):WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RF/SpawnMachine.Action"):InvokeServer(unpack({"Withdraw", m}))
        else
            Rayfield:Notify({Title = "Error", Content = "Machine not found to withdraw from.", Duration = 3})
        end
    end,
})

Afk:CreateButton({Name = "Go to Surface", Callback = function() tweenToSurface(surfaceCoords) end})

local SettingsTab = Window:CreateTab("Settings", 4483345998)
SettingsTab:CreateButton({
    Name = "Destroy UI",
    Callback = function()
        Rayfield:Destroy()
    end,
})

SettingsTab:CreateLabel("Alpha Hub V1.0")

game:GetService("UserInputService").JumpRequest:Connect(function()
    if _G.InfJump then
        pcall(function()
            Player.Character:FindFirstChildOfClass('Humanoid'):ChangeState("Jumping")
        end)
    end
end)

Rayfield:Notify({
    Title = "Alpha Hub Loaded",
    Content = "Welcome, " .. Player.DisplayName .. "!",
    Duration = 5,
    Image = 4483345998,
})
